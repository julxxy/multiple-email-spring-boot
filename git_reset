#!/usr/bin/env bash
# äº¤äº’å¼æ¸…ç†ï¼Œæ¯ä¸ªåˆ†æ”¯éƒ½ä¼šç¡®è®¤

set -e

echo "=== æ¸…ç†æ‰€æœ‰åˆ†æ”¯çš„æäº¤è®°å½•ï¼ˆä¿ç•™ä»£ç ï¼‰ ==="
echo ""

# è·å–æ‰€æœ‰åˆ†æ”¯
branches=($(git branch | sed 's/^\*\?[ \t]*//' | grep -v '^$'))

echo "å‘ç°ä»¥ä¸‹åˆ†æ”¯ï¼š"
for i in "${!branches[@]}"; do
  echo "$((i+1)). ${branches[i]}"
done

echo ""
read -p "ç¡®è®¤è¦æ¸…ç†è¿™äº›åˆ†æ”¯çš„å†å²è®°å½•å—ï¼Ÿ(y/N): " confirm
if [[ $confirm != "y" && $confirm != "Y" ]]; then
  echo "æ“ä½œå·²å–æ¶ˆ"
  exit 0
fi

echo ""
echo "å¼€å§‹å¤„ç†..."

for branch in "${branches[@]}"; do
  echo ""
  echo ">>> å¤„ç†åˆ†æ”¯: $branch"

  # æ˜¾ç¤ºå½“å‰åˆ†æ”¯çš„æäº¤æ•°é‡
  commit_count=$(git rev-list --count "$branch" 2>/dev/null || echo "0")
  echo "å½“å‰æäº¤æ•°: $commit_count"

  # åˆ‡æ¢åˆ°åˆ†æ”¯
  git checkout "$branch"

  # æ˜¾ç¤ºæ–‡ä»¶æ•°é‡
  file_count=$(find . -type f -not -path './.git/*' | wc -l)
  echo "å½“å‰æ–‡ä»¶æ•°: $file_count"

  # åˆ›å»ºå­¤ç«‹åˆ†æ”¯
  git checkout --orphan "temp-clean-$branch"

  # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
  git add -A

  # æäº¤
  git commit -m "Clean history for branch: $branch ($(date '+%Y-%m-%d %H:%M:%S'))"

  # æ›¿æ¢åŸåˆ†æ”¯
  git branch -D "$branch"
  git branch -m "$branch"

  echo "âœ… $branch å®Œæˆ (1ä¸ªæäº¤, $file_countä¸ªæ–‡ä»¶)"
done

echo ""
echo "ğŸ‰ å®Œæˆï¼æ‰€æœ‰åˆ†æ”¯ä¿ç•™ï¼Œå†å²å·²æ¸…ç†"
echo ""
git branch -v
